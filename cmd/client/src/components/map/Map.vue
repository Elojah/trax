<script setup lang="ts">
import "leaflet/dist/leaflet.css";
import { LMap, LTileLayer, LMarker, Functions } from "@vue-leaflet/vue-leaflet";
import { ref, toRefs } from "vue";
import type { Position } from "@pkg/geometry/position";
import MarkerCreate from "@/components/map/MarkerCreate.vue";
import { useReverseGeocoding } from "@/composables/useReverseGeocoding";
import { useErrorsStore } from "@/stores/errors";

const errorsStore = useErrorsStore();
const { error, message } = toRefs(errorsStore);

let zoom = 3; // Default zoom level
const cursor = ref<Position>();
const visible = ref(false);
const center = ref([47.41322, -1.219482]);
const address = ref<string>('');

// Reverse geocoding composable
const { reverseGeocode, formatAddress, loading: geocodingLoading, error: geocodingError } = useReverseGeocoding();

// Define max bounds to prevent showing dark areas at extreme latitudes
const maxBounds = ref([
	[-85, -180], // Southwest coordinates
	[85, 180]    // Northeast coordinates
]);

const openMarkerPanel = async (event: any) => {
	// Display temporary marker at clicked position
	const { lat, lng } = event.latlng;
	// Convert to the Position format used by the backend (assuming micro-degrees)
	cursor.value = {
		lat: lat,
		lng: lng,
	};

	// Center map on clicked position (bounds will be enforced by maxBounds)
	center.value = [lat, lng];

	// Perform reverse geocoding using the regular lat/lng numbers
	try {
		const geocodingResult = await reverseGeocode(lat, lng);
		if (geocodingResult) {
			address.value = formatAddress(geocodingResult);
		} else {
			address.value = `${(lat * 1e6).toFixed(6)}, ${(lng * 1e6).toFixed(6)}`;
		}
	} catch (err) {
		message.value = 'Failed to reverse geocode location: ' + err;
		error.value = true;

		address.value = `${(lat * 1e6).toFixed(6)}, ${(lng * 1e6).toFixed(6)}`;
	}

	// Open MarkerPanel with the clicked position
	visible.value = true;
};

const pawIconHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
							<path
								d="M298.5 156.9C312.8 199.8 298.2 243.1 265.9 253.7C233.6 264.3 195.8 238.1 181.5 195.2C167.2 152.3 181.8 109 214.1 98.4C246.4 87.8 284.2 114 298.5 156.9zM164.4 262.6C183.3 295 178.7 332.7 154.2 346.7C129.7 360.7 94.5 345.8 75.7 313.4C56.9 281 61.4 243.3 85.9 229.3C110.4 215.3 145.6 230.2 164.4 262.6zM133.2 465.2C185.6 323.9 278.7 288 320 288C361.3 288 454.4 323.9 506.8 465.2C510.4 474.9 512 485.3 512 495.7L512 497.3C512 523.1 491.1 544 465.3 544C453.8 544 442.4 542.6 431.3 539.8L343.3 517.8C328 514 312 514 296.7 517.8L208.7 539.8C197.6 542.6 186.2 544 174.7 544C148.9 544 128 523.1 128 497.3L128 495.7C128 485.3 129.6 474.9 133.2 465.2zM485.8 346.7C461.3 332.7 456.7 295 475.6 262.6C494.5 230.2 529.6 215.3 554.1 229.3C578.6 243.3 583.2 281 564.3 313.4C545.4 345.8 510.3 360.7 485.8 346.7zM374.1 253.7C341.8 243.1 327.2 199.8 341.5 156.9C355.8 114 393.6 87.8 425.9 98.4C458.2 109 472.8 152.3 458.5 195.2C444.2 238.1 406.4 264.3 374.1 253.7z" />
						</svg>
`

</script>

<template>
	<div class="h-full w-full relative">
		<l-map ref="map" :zoom="zoom" :min-zoom="3" :center="center" :max-bounds="maxBounds" class="h-full w-full"
			@click="openMarkerPanel">
			<l-tile-layer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" layer-type="base"
				name="map"></l-tile-layer>

			<!-- Render cursor marker -->
			<l-marker v-if="cursor" :lat-lng="[cursor.lat, cursor.lng]">
				<l-icon v-html="pawIconHTML">
				</l-icon>
			</l-marker>
		</l-map>

		<!-- MarkerPanel - Now outside the map, positioned absolutely -->
		<MarkerCreate :visible="visible" :address="address" :coordinates="cursor" :geocoding-loading="geocodingLoading"
			:geocoding-error="geocodingError" @close="visible = false" />
	</div>
</template>
<style>
.leaflet-container {
	background-color: rgba(255, 0, 0, 0.0);
	height: 100%;
	width: 100%;
	/* Fallback minimum height */
	min-height: 400px;
}

.leaflet-layer,
.leaflet-control-zoom-in,
.leaflet-control-zoom-out,
.leaflet-control-attribution {
	filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
}

.leaflet-control {
	z-index: 0 !important
}

.leaflet-pane {
	z-index: 0 !important
}

.leaflet-top,
.leaflet-bottom {
	z-index: 0 !important
}
</style>
